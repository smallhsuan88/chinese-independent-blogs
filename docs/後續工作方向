ğŸŸ¡ ä¸­æœŸå»ºè­°ï¼ˆä¸‹ä¸€å€‹å¯¦éš›åŠŸèƒ½ï¼šä½ æœƒæ˜é¡¯æ„Ÿè¦ºã€Œèƒ½ç”¨äº†ã€ï¼‰
3ï¸âƒ£ å»ºç«‹ã€Œä½œè€…å¾Œå°ã€æŸ¥è©¢ï¼ˆauthenticated onlyï¼‰
ç›®æ¨™

è®“ä½ ç™»å…¥å¾Œåªçœ‹åˆ°ã€Œè‡ªå·±çš„æ–‡ç« ï¼ˆå« draftï¼‰ã€ï¼å¾Œå°æ–‡ç« åˆ—è¡¨ï¼ˆç®¡ç†è‰ç¨¿ã€ç·¨è¼¯ã€åˆªé™¤å…¥å£ï¼‰ã€‚

å»ºç½®é …ç›®

A. SQL é©—è­‰ç‰ˆï¼ˆä½ å·²åœ¨ SQL Editor èƒ½è·‘ï¼‰

set local role authenticated;
select set_config('request.jwt.claim.sub', '<ä½ çš„ uid>', true);

select id, title, slug, status, published_at, created_at, category, tags
from public.posts
where author_id = auth.uid()
order by created_at desc;


B. å‰ç«¯ JS å¾Œå°é é¢ï¼ˆå»ºè­°æ–°å¢ä¸€é ï¼‰

æ–°å¢ admin.htmlï¼ˆæˆ– editor.htmlï¼‰

åŠŸèƒ½ï¼šç™»å…¥ â†’ å–å¾— session â†’ eq('author_id', user.id) â†’ åˆ—å‡ºè‰ç¨¿/å·²ç™¼å¸ƒ

ä½ ç¾éšæ®µæ˜¯ GitHub Pages éœæ…‹ç«™ï¼Œç™»å…¥å¯å…ˆç”¨ Supabase Authï¼ˆEmail OTP / magic linkï¼‰æˆ–å…ˆç”¨ã€Œæš«æ™‚ admin keyã€æ¦‚å¿µï¼Œä½†æˆ‘å»ºè­°ç›´æ¥èµ° Supabase Authï¼ˆå®‰å…¨å¾ˆå¤šï¼‰ã€‚

é©—è­‰ï¼ˆå¿…åšï¼‰

æœªç™»å…¥ï¼šæ‰“é–‹ admin.html â†’ æ‡‰è©²é¡¯ç¤ºã€Œè«‹å…ˆç™»å…¥ã€

å·²ç™»å…¥ï¼šåªçœ‹åˆ°è‡ªå·±çš„æ–‡ç« 

ç”¨ä½ å‰›å‰›æ¸¬è©¦ non-owner uid çš„æ¦‚å¿µï¼šæ›ä¸€å€‹å¸³è™Ÿç™»å…¥ â†’ ä¸æœƒçœ‹åˆ°ä½ çš„æ–‡ç« 

é¢¨éšªç›²é»èˆ‡æ‡‰è®Š

ç›²é»ï¼šä½ ç”¨ anon key å‘¼å«å¾Œå° APIï¼Œè‹¥æ²’ç™»å…¥ sessionï¼Œæœƒè¢« RLS æ“‹ï¼Œç•«é¢ç©ºç™½ï¼Œçœ‹èµ·ä¾†åƒå£æ‰
â†’ æ‡‰è®Šï¼šå‰ç«¯å…ˆæª¢æŸ¥ sb.auth.getSession()ï¼Œæ²’æœ‰ session å°±ç›´æ¥æç¤ºç™»å…¥ï¼Œä¸è¦ç¡¬æŸ¥ postsã€‚

4ï¸âƒ£ è‰ç¨¿ â†’ ç™¼å¸ƒ çš„æ­£å¼æµç¨‹ï¼ˆå¼·çƒˆå»ºè­°ï¼‰
ç›®æ¨™

æŠŠã€Œç™¼å¸ƒã€ç•¶ä½œä¸€å€‹æ˜ç¢ºå‹•ä½œï¼Œç¢ºä¿ï¼š

draft æ°¸é ä¸æœƒè¢«åŒ¿åè®€åˆ°

published ä¸€å®šæœ‰ published_at

ä½ å‰ç«¯ .not('published_at', 'is', null) æ°¸é ä¹¾æ·¨

å»ºç½®æ–¹å¼ï¼ˆå…ˆåšæœ€ç°¡ç‰ˆï¼‰

A. ç™¼å¸ƒ SQL

update public.posts
set status = 'published',
    published_at = now()
where id = :post_id
  and author_id = auth.uid();


B. å–æ¶ˆç™¼å¸ƒï¼ˆå¯é¸ä½†å»ºè­°ï¼‰

update public.posts
set status = 'draft',
    published_at = null
where id = :post_id
  and author_id = auth.uid();

é©—è­‰ï¼ˆå¿…åšï¼‰

å»ºä¸€ç¯‡ draftï¼ˆpublished_at = nullï¼‰â†’ blog.html ä¸æ‡‰é¡¯ç¤º

åŸ·è¡Œç™¼å¸ƒ â†’ blog.html æ‡‰é¡¯ç¤º

å–æ¶ˆç™¼å¸ƒ â†’ blog.html æ‡‰æ¶ˆå¤±

é¢¨éšªç›²é»èˆ‡æ‡‰è®Š

ç›²é»ï¼šæœ‰äººç›´æ¥æŠŠ status æ”¹æˆ publishedï¼Œä½†å¿˜äº†å¡« published_at
â†’ æ‡‰è®Šï¼ˆä¸­æœŸåŠ å¼·ç‰ˆï¼‰ï¼šåšã€Œè³‡æ–™ä¸€è‡´æ€§ã€ä¿è­·ï¼ˆè¦‹ä¸‹æ–¹åŠ å¼·å»ºè­°ï¼‰

ä¸­æœŸåŠ å¼·ï¼ˆæ¨è–¦ï¼‰

åŠ  DB constraintï¼Œé¿å… status='published' å» published_at is null

æ¦‚å¿µï¼šcheck (status != 'published' OR published_at IS NOT NULL)

é€™æ¨£è³‡æ–™åº«æœƒå¹«ä½ æ“‹ä½ã€ŒåŠå¥—ç™¼å¸ƒã€ã€‚

ğŸ”µ é•·æœŸå»ºè­°ï¼ˆå°ˆæ¥­ç­‰ç´šï¼šå¯æ…¢æ…¢ä¾†ï¼Œä½†æœƒè®“ç”¢å“åƒçœŸçš„ï¼‰
5ï¸âƒ£ Preview Token ç§ä¸‹é è¦½è‰ç¨¿ï¼ˆä½ å·²ç¶“æœ‰ preview_tokenï¼‰
ç›®æ¨™

æœªç™»å…¥è€…ä¹Ÿèƒ½ã€Œç”¨ä¸€å€‹ç§˜å¯†é€£çµã€é è¦½è‰ç¨¿ï¼š

çµ¦è€å©†å¯©ç¨¿

çµ¦æœ‹å‹çœ‹æ’ç‰ˆ

ä¸æœƒå…¬é–‹å‡ºç¾åœ¨åˆ—è¡¨

å»ºç½®é …ç›®

A. å‰ç«¯

é è¦½ç¶²å€ï¼š/post.html?preview=<uuid>&slug=<slug>

JS åœ¨æŸ¥æ–‡ç« æ™‚ï¼š

æœ‰ preview token â†’ ç”¨å®ƒæŸ¥ï¼ˆæˆ–å¸¶ header/settingï¼‰

B. RLS Policyï¼ˆSELECT å¢å¼·ï¼‰
ä½ æçš„æ–¹å‘æ˜¯å°çš„ï¼Œä½†é‡é»æ˜¯ï¼š
Supabase client é è¨­ä¸æœƒå¹«ä½ å¡ current_setting('request.preview_token')ï¼Œä½ éœ€è¦åœ¨ SQL ç«¯æˆ– RPC function åšè™•ç†ï¼Œæˆ–ç”¨ã€Œè‡ªè¨‚ header â†’ database settingã€çš„æ–¹å¼ã€‚

æ¯”è¼ƒç©©çš„åšæ³•ï¼ˆé•·æœŸæ›´æ¨è–¦ï¼‰ï¼šåšä¸€å€‹ RPC function

rpc('get_post_by_preview', { slug, token })

function è£¡é¢æ¯”å° tokenï¼Œå›å‚³æ–‡ç« 

é€™æ¨£ä½ ä¸ç”¨åœ¨å‰ç«¯æ set_config

é©—è­‰

æœªç™»å…¥ä¸”æ²’æœ‰ preview token â†’ çœ‹ä¸åˆ°è‰ç¨¿

æœªç™»å…¥ä½†æœ‰ token â†’ çœ‹å¾—åˆ°è‰ç¨¿

token éŒ¯ â†’ çœ‹ä¸åˆ°

é¢¨éšªèˆ‡æ‡‰è®Š

ç›²é»ï¼štoken è¢«è½‰å‚³ï¼ç­‰æ–¼åˆ†äº«æ¬Šé™
â†’ æ‡‰è®Šï¼štoken å¯å®šæœŸè¼ªæ›ã€å¯åŠ  preview_expires_atã€æˆ–ã€Œæ¯æ¬¡ç”¢ç”Ÿæ–° token ä½¿èˆŠ token å¤±æ•ˆã€ã€‚

6ï¸âƒ£ Admin roleï¼ˆç«™é•·æ¬Šé™ï¼‰
ç›®æ¨™

æœªä¾†ä½ è¦åšç«™å‹™ï¼š

åˆªæ‰é•è¦æ–‡

ä¿®å¾©ç•°å¸¸è³‡æ–™

ç·Šæ€¥ä¸‹æ¶

å»ºç½®ç­–ç•¥ï¼ˆå»ºè­°èµ°ã€Œæœ€ç©©ã€ï¼‰

ä½ æ admin_emails æ¦‚å¿µæ˜¯ OK çš„ï¼Œä½†æˆ‘æœƒå»ºè­°ç”¨ Supabase Auth çš„ã€Œè§’è‰²/claimã€æˆ–åšä¸€å¼µ admins è¡¨æ­é… policyã€‚

ç°¡åŒ–å¯è¡Œç‰ˆï¼ˆä½ ç¾æœ‰ admin_emails è¡¨ï¼‰

ä½ çš„ UPDATE/DELETE policy åŠ ä¸€æ®µï¼š

ä½œè€…æœ¬äººå¯ä»¥å‹•

æˆ– admin email åœ¨æ¸…å–®å…§å¯å‹•

é©—è­‰

é admin å¸³è™Ÿï¼šä¸èƒ½æ”¹åˆ¥äººçš„æ–‡

admin å¸³è™Ÿï¼šèƒ½æ”¹åˆ¥äººçš„æ–‡

é¢¨éšªç›²é»èˆ‡æ‡‰è®Š

ç›²é»ï¼šç”¨ email ç•¶åˆ¤æ–·åŸºæº–ï¼Œæœªä¾†è‹¥æ›´æ› email å¯èƒ½éº»ç…©
â†’ æ‡‰è®Šï¼šé•·æœŸæ”¹æˆç”¨ auth.uid() å­˜ admins è¡¨ï¼ˆæ›´ç©©ï¼‰ï¼Œemail åªæ˜¯é¡¯ç¤ºç”¨ã€‚

âœ… å»ºè­°ä½ æ¥ä¸‹ä¾†çš„ã€Œä¸­æœŸè½åœ°é †åºã€ï¼ˆæœ€æœ‰æ„Ÿã€æœ€ä¸å®¹æ˜“å¡ï¼‰

å…ˆåš 3ï¼šä½œè€…å¾Œå°åˆ—è¡¨é  admin.htmlï¼ˆä½ æœƒç«‹åˆ»è¦ºå¾—èƒ½ç®¡ç†ï¼‰

å†åš 4ï¼šç™¼å¸ƒ/å–æ¶ˆç™¼å¸ƒæŒ‰éˆ•ï¼ˆè³‡æ–™ä¹¾æ·¨ã€å‰å°ç©©ï¼‰

ç„¶å¾Œæ‰åš 5ï¼špreview tokenï¼ˆé–‹å§‹æœ‰ã€Œå¯©ç¨¿æµç¨‹ã€ï¼‰

æœ€å¾Œåš 6ï¼šadmin roleï¼ˆç«™å‹™æ“´å¼µï¼‰

ä½ ç¾åœ¨å¯ä»¥ç«‹åˆ»é–‹å·¥çš„ä¸‹ä¸€æ­¥ï¼ˆæˆ‘å¹«ä½ é¸æœ€å„ªå…ˆï¼‰

âœ… å…ˆåšã€Œadmin.htmlã€ä½œè€…å¾Œå°åˆ—è¡¨ã€‚
ä½ å›æˆ‘ä¸€å¥ï¼šä½ æƒ³è¦å¾Œå°ç™»å…¥ç”¨ Email magic link é‚„æ˜¯ å…ˆç”¨ä½ è‡ªå·±çš„å¸³å¯†/OTPï¼Ÿ
æˆ‘å°±ç›´æ¥çµ¦ä½ å¯è²¼çµ¦ Codex çš„è¦æ ¼èˆ‡æª”æ¡ˆçµæ§‹ï¼ˆå« admin.html + script.js æ€éº¼æ‹†ï¼‰ã€‚
