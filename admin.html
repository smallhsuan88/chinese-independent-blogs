<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>作者後台</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif; margin:24px; max-width:900px;}
    input,button,textarea{font-size:16px; padding:10px; margin:6px 0;}
    textarea{width:100%; height:140px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .card{border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0;}
    .muted{color:#666;}
    .danger{color:#b00020;}
    .ok{color:#0b7a0b;}
    .small{font-size:13px;}
    .hr{height:1px;background:#eee;margin:10px 0;}
    button{cursor:pointer;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>作者後台</h1>

  <div id="status" class="muted">初始化中…</div>

  <div id="authBox" class="card">
    <h3>登入（雙模式：Password / Magic Link）</h3>

    <label class="small muted">Email</label><br/>
    <input id="email" placeholder="you@example.com" style="width:320px;" autocomplete="email" />

    <div class="hr"></div>

    <!-- A) Password Login -->
    <div>
      <div class="row">
        <div style="min-width:140px;"><b>Password 登入</b></div>
        <button id="btnLoginPassword">Email + Password 登入</button>
      </div>

      <label class="small muted">Password</label><br/>
      <input id="password" type="password" placeholder="password" style="width:320px;" autocomplete="current-password" />

      <div class="row">
        <button id="btnSignUpPassword" title="建立帳號（只建議你自己用）">建立帳號（Sign up）</button>
        <button id="btnResetPassword" title="寄送重設密碼信（也會吃寄信額度）">忘記密碼（寄重設信）</button>
      </div>
      <div class="muted small">
        建議：你目前 Free 方案寄信額度非常小，若 Magic Link 常失敗，請優先用 Password 模式。
      </div>
    </div>

    <div class="hr"></div>

    <!-- B) Magic Link Login -->
    <div>
      <div class="row">
        <div style="min-width:140px;"><b>Magic Link 登入</b></div>
        <button id="btnLoginMagic">寄送登入連結</button>
      </div>
      <div class="muted small">提示：信件可能在垃圾郵件；Free 額度可能導致寄信失敗。</div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button id="btnLogout" style="display:none;">登出</button>
    </div>
  </div>

  <div id="app" style="display:none;">
    <div class="card">
      <h3>新增草稿</h3>
      <input id="newTitle" placeholder="標題" style="width:100%;" />
      <input id="newSlug" placeholder="slug（例如 my-post-20251224）" style="width:100%;" />
      <textarea id="newContent" placeholder="內容（可先隨便）"></textarea>
      <button id="btnCreateDraft">建立 draft</button>
      <div id="createMsg" class="muted"></div>
    </div>

    <h3>我的文章</h3>
    <div id="list"></div>
  </div>

  <script>
    // ===== 0) Supabase 設定 =====
    const SUPABASE_URL = "https://kxilbdbtzoscutxjzbss.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4aWxiZGJ0em9zY3V0eGp6YnNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTQzMzgsImV4cCI6MjA4MjA5MDMzOH0.xWhjqKF9DeqY3t3RJaU4FoL1LRRkxgYkZ34L9fgFh8g";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // GitHub Pages 固定回跳（建議用固定值，避免路徑變動）
    const ADMIN_REDIRECT = "https://smallhsuan88.github.io/chinese-independent-blogs/admin.html";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const appEl = $("app");
    const btnLogout = $("btnLogout");
    const listEl = $("list");

    function setStatus(msg, cls="muted"){
      statusEl.className = cls;
      statusEl.textContent = msg;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // ===== 1) UI 切換 & 列表 =====
    async function refreshMeAndList(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        appEl.style.display = "none";
        btnLogout.style.display = "none";
        setStatus("尚未登入（只能看公開 blog）", "muted");
        return;
      }

      btnLogout.style.display = "inline-block";
      appEl.style.display = "block";
      setStatus(`已登入：${user.email}（uid: ${user.id}）`, "ok");

      const { data, error } = await sb
        .from("posts")
        .select("id,title,slug,status,published_at,created_at")
        .order("created_at", { ascending: false });

      if(error){
        listEl.innerHTML = `<div class="danger">讀取失敗：${escapeHtml(error.message)}</div>`;
        return;
      }

      if(!data || data.length === 0){
        listEl.innerHTML = `<div class="muted">目前沒有文章</div>`;
        return;
      }

      listEl.innerHTML = data.map(p => `
        <div class="card">
          <div><b>${escapeHtml(p.title || "(無標題)")}</b></div>
          <div class="muted">slug: ${escapeHtml(p.slug || "")}</div>
          <div class="row">
            <div>狀態：<b>${escapeHtml(p.status)}</b></div>
            <div class="muted">published_at：${p.published_at ? escapeHtml(p.published_at) : "-"}</div>
          </div>
          <div class="row">
            <button onclick="publishPost('${p.id}')">發布</button>
            <button onclick="toDraft('${p.id}')">改回草稿</button>
            <button onclick="deletePost('${p.id}')" class="danger">刪除</button>
          </div>
        </div>
      `).join("");
    }

    // ===== 2) Password 模式 =====
    $("btnLoginPassword").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if(!email) return setStatus("請輸入 email", "danger");
      if(!password) return setStatus("請輸入 password", "danger");

      setStatus("Password 登入中…", "muted");
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) return setStatus("登入失敗：" + error.message, "danger");

      setStatus("登入成功", "ok");
      await refreshMeAndList();
    };

    // （可選）建立帳號：只建議你自己用；若開放 signups 可能被亂註冊
    $("btnSignUpPassword").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if(!email) return setStatus("請輸入 email", "danger");
      if(!password) return setStatus("請輸入 password", "danger");

      setStatus("建立帳號中…", "muted");
      const { error } = await sb.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: ADMIN_REDIRECT } // 若你有開 Confirm email，會走寄信流程（也可能被限流）
      });

      if(error) return setStatus("建立失敗：" + error.message, "danger");

      // 若 Confirm email = ON，這裡會提示去收信；若 OFF，則可直接登入
      setStatus("已送出建立帳號（若需驗證，請收信完成驗證後再登入）", "ok");
    };

    // 忘記密碼（會寄信，也吃寄信額度）
    $("btnResetPassword").onclick = async () => {
      const email = $("email").value.trim();
      if(!email) return setStatus("請輸入 email", "danger");

      setStatus("寄送重設密碼信中…", "muted");
      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: ADMIN_REDIRECT // 你之後可加一個 reset-password.html 來處理更新密碼；先回 admin.html 也行
      });

      if(error) return setStatus("寄送失敗：" + error.message, "danger");
      setStatus("已寄出重設密碼信（請收信）", "ok");
    };

    // ===== 3) Magic Link 模式 =====
    $("btnLoginMagic").onclick = async () => {
      const email = $("email").value.trim();
      if(!email) return setStatus("請輸入 email", "danger");

      setStatus("寄送登入連結中…", "muted");
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: ADMIN_REDIRECT
        }
      });

      if(error) setStatus("寄送失敗：" + error.message, "danger");
      else setStatus("已寄出登入連結，請去收信點擊登入。", "ok");
    };

    // ===== 4) 登出 =====
    btnLogout.onclick = async () => {
      await sb.auth.signOut();
      await refreshMeAndList();
    };

    // ===== 5) CRUD =====
    $("btnCreateDraft").onclick = async () => {
      const title = $("newTitle").value.trim();
      const slug  = $("newSlug").value.trim();
      const content = $("newContent").value.trim();

      if(!slug){
        $("createMsg").textContent = "slug 必填（且不能重複）";
        return;
      }

      $("createMsg").textContent = "建立中…";

      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        $("createMsg").textContent = "你尚未登入";
        return;
      }

      const { error } = await sb.from("posts").insert({
        title,
        slug,
        content,
        status: "draft",
        published_at: null,
        author_id: user.id
      });

      if(error) $("createMsg").textContent = "建立失敗：" + error.message;
      else {
        $("createMsg").textContent = "建立成功";
        $("newTitle").value = "";
        $("newSlug").value = "";
        $("newContent").value = "";
        await refreshMeAndList();
      }
    };

    window.publishPost = async (id) => {
      const { error } = await sb.from("posts").update({
        status: "published",
        published_at: new Date().toISOString()
      }).eq("id", id);

      if(error) alert("發布失敗：" + error.message);
      await refreshMeAndList();
    };

    window.toDraft = async (id) => {
      const { error } = await sb.from("posts").update({
        status: "draft",
        published_at: null
      }).eq("id", id);

      if(error) alert("更新失敗：" + error.message);
      await refreshMeAndList();
    };

    window.deletePost = async (id) => {
      if(!confirm("確定刪除？")) return;
      const { error } = await sb.from("posts").delete().eq("id", id);
      if(error) alert("刪除失敗：" + error.message);
      await refreshMeAndList();
    };

    // ===== 6) init：處理 Magic Link 回跳 code -> session =====
    (async () => {
      try {
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");
        // Magic Link（PKCE flow）回來會帶 code
        if (code) {
          setStatus("驗證中…", "muted");
          const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
          if (error) throw error;

          // 清掉 code，避免重整重複 exchange
          url.searchParams.delete("code");
          window.history.replaceState({}, document.title, url.toString());
          setStatus("登入成功", "ok");
        }
      } catch (e) {
        console.error(e);
        setStatus("驗證失敗：" + (e?.message || e), "danger");
      }

      sb.auth.onAuthStateChange(() => refreshMeAndList());
      refreshMeAndList();
    })();
  </script>
</body>
</html>
